# 一、芯片启动
- ld文件定义多个变量供c库使用，主要是各个段的起始和结束地址；
- ld中定义的堆栈大小是编译时检查使用，实际程序不会用到；
- ld中的estack和bss_end分别对应着栈顶和堆起始地址，实际堆栈溢出cpu是不检测的，靠用户实现；
- 启动文件定义中断向量表；初始化msp和pc指针，指定中断向量表（每个中断函数地址）；初始化时钟；搬运data段、bss段；跳转main函数；
---
# 二、外设初始化
## 2.1 systemtick初始化
- 配置系统定时器（重载值、中断、使能）、配置nvic(开启系统时钟中断)、系统定时器isr（hal库tick++）；该配置会在rcc配置完重新配置一便，因为cpu上电先用的hci**cpu核心外设似乎不需要RCC配置，包括NVIC和系统时钟定时器**
## 2.2 AFIO配置
afio可以把一些复用功能重新映射到其他引脚上，可控制sw、jtag、spi、uart、exit等；同一个一脚可以连接多个外设，所以外设引脚冲突时，外设rcc只能使能其中一个，或者afio重映射到其他引脚，可映射的引脚是固定的不是随意的；
## 2.3 GPIO配置
- 速度指的是电平攀升或者下降的时间，使用低速应用时可以适当降低速度；
- 每个复用功能都有自己的gpio配置，可查看用户手册；
## 2.4 外部中断配置
- 触发（上升、下降、全）、exitlin、使能、中断/事件；
## 2.5UART配置
### 2.5.1底层小结
uart发送就是向dr寄存器写数据，然后读状态寄存器查看是否发送完成，发送完成可产生中断；写操作自动清零发送结束中断
uart接受就是读取rxne状态位，状态位就绪后读取dr寄存器；rxnc可产生中断；读操作自动清除rxne中断；
### 2.5.2驱动小结
分层设计：  
1.状态标志，包括锁定状态、运行状态；  
2.配置参数，包括波特率、校验位等；  
3.驱动缓存，tx和rx buffer；  
4.注册回调，供用户拓展；
### 2.5.3配置小结
- 波特率、停止位、校验位、流控；
- 中断使能、nvic通道使能，外设使能，rcc使能；
- dma配置
## 2.6nvic配置
- 配置优先级组
- 为需要使用的中断配置优先级
## 2.7 定时器
### 2.7.1 时基单元
- 预分频器：多少次时钟基数+1
- 自动重装器：达到存储的计数值时清空计数器
- 计数器：按照预分屏器设置自增、自减、中间对齐
- 中断（标志手动清零）：自动重装器重装时、输入捕获和输出比较匹配时、外部时钟输入边沿变化时
### 2.7.2 基本功能
- 内外时钟源选择：内部外设总线时钟、内部：trgi(其他定时器的trgo（itr）)、外部：tim_etr引脚 （可配置滤波、分频、边沿检测）、外部：tim_ch引脚；不同外部引脚连接内部的单元不同，所以功能不同
- 输出比较:把cnt的值和ccr的值比较，来控制对应的oc引脚的高低电平转换
- 输入捕获:把cnt的值转运到ccr，要求测量频率远小于内部时钟，否则误差大
- 主从触发：也就是产生事件，事件触发别的外设工作，全程不需要cpu参与，和外部中断触发事件类似，是stm32硬件自动化的功能
- 编码器计数:输入捕获引脚除了可以捕获边沿，还可以检测电平高低，这样通道一捕获之后查看通道2电平状态就能知道编码器向哪转了，从而控制cnt++或者--，单位事件读取cnt的值能算速度；
- 缓冲寄存器：自动重装、预分频、比较等，会在一个周期后再加载值到实际的运行寄存器
## 2.8 ADC
- ADC只有一个比较器，所以只能一个一个转换，通过组可以设置一批待转换的通道，然后adc按组去顺序转换，注入组有四个寄存器存储，数据不会立马覆盖，规则组只有一个，一般搭配dma防止被覆盖
- 转换完成可以置标志位和中断标志位，同时可以和模拟看门狗值（比较寄存器）做比较，大于或小于就触发中断；
- adc基本都有校准过程，无需关心过程，记住调用api就行
- 因为是12位精度寄存器，所以最终转换值要选择对齐方式，左或者右
## 2.9 IIC
- 支持一主多从，多主多从
- 两个引脚都要设置为开漏输出，总线上添加若上拉电路
- iic单字节时序描述：起始位scl高电平（空闲）sda被拉低，结束位：scl高电平时，sda被拉高，注意这是在高电平时发生变化，而数据在高电平时sda是稳定的，随后scl被拉低，此时sda电平可以进行切换，在scl恢复高电平时，保持住sda的电平状态供接收方读取；
- 通信流程：必须有的、统一的：iic加入地址机制，7bit地址+1bit r/w,紧接着主机读取一位应答位；紧接者直接进行下一位传输，直至传输完出现结束位（变化电平）
### 2.9.1 总结
iic协议只管前两个字节数据，后续数据厂家自己约定，第一个字节数据掌控着是否将sda控制权交给从机，第二个字节决定要操作的寄存器地址，复合读写就是先写地址然后不用结束位直接启用起始位改为读行为，这时候读的数据就是写操作时第二个字节指定的地址，因为只有一个字节表示寄存器地址，所以iic外设估计就只有256字节的数据
## 2.10 spi（四种模式）
spi的第一个上升延主从机开始输出电平，sck第二个下降沿主从机开始采样数据，中间时间供翻转电平；cpoL：0，cph:0
spi的第一个上升延主从机开始采样数据，sck第二个下降沿主从机开始输出电平，中间时间供翻转电平；这个可以把sclk下降沿当作开始输出电平，cpoL：0，cph:1
# 2.11 W25Q64
- 整个chip划分为多个block，一个block（64K）换分多个sector，一个sector(4k)划分多个page，page(256B)内包含byte
- 最大编程单位为page（flash内部的缓冲区大小就是一个page），先写入缓冲区，然后flash值为busy，这时falsh在搬运数据；
- 写流程：写使能→擦除对应的最小擦除单元（sector）（原因：只能由1改0，所以先全部写1）→等busy消失→写（最大单位为1个page（地址不能跨页））→等busy消失→结束
- 读流程：等busy消失（无需使能、没有读取量限制、没有跨页限制）→读→结束；